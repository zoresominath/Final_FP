{% extends "base.html" %}

{% block sidebar %}{% endblock %}

{% block content %}
<style>
    /* 1. Floating Action Button (Scanner) */
    .fab-scan {
        position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px;
        border-radius: 50%; background: linear-gradient(135deg, #0d6efd, #0a58ca);
        color: white; display: flex; align-items: center; justify-content: center;
        box-shadow: 0 8px 20px rgba(13, 110, 253, 0.4); font-size: 24px; z-index: 1050;
        transition: all 0.3s ease; border: 2px solid white; text-decoration: none;
    }
    .fab-scan:hover { transform: scale(1.1); color: white; }

    /* 2. Styles Copied from Customer Dashboard (Floating Pills) */
    .nav-pills .nav-link { 
        color: #495057; font-weight: 500; padding: 10px 15px; border-radius: 10px; 
        transition: all 0.3s ease; margin-bottom: 5px; border: 1px solid transparent; 
    }
    .nav-pills .nav-link:hover { 
        background-color: #f8f9fa; color: #0d6efd; border-color: #e9ecef; transform: translateX(5px); 
    }
    .nav-pills .nav-link.active { 
        background: linear-gradient(45deg, #0d6efd, #0a58ca); color: white; 
        box-shadow: 0 4px 6px rgba(13, 110, 253, 0.3); border-color: transparent; 
    }
    .nav-pills .nav-link i { font-size: 1.1rem; margin-right: 10px; vertical-align: middle; }
    
    .profile-section { text-align: center; margin-bottom: 1.5rem; }
    .sidebar-profile-img { width: 90px; height: 90px; border-radius: 50%; object-fit: cover; border: 3px solid #e9ecef; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 10px; }
    
    /* --- UPDATED TITLE STYLE (YELLOW/GOLD) --- */
    .mess-title-gradient { 
        background: -webkit-linear-gradient(45deg, #FFD700, #ff8c00); 
        -webkit-background-clip: text; 
        background-clip: text; 
        -webkit-text-fill-color: transparent; 
        font-family: 'Lobster', cursive; 
        font-size: 2rem; 
        text-shadow: 2px 2px 4px rgba(0,0,0,0.1); 
    }

    /* 3. Owner Specific Styles (Cards/Charts) */
    .stat-card { color: white; border: none; overflow: hidden; position: relative; border-radius: 12px; }
    .stat-card h2 { font-weight: 700; }
    .stat-card .icon-bg { position: absolute; right: 10px; bottom: 10px; font-size: 4rem; opacity: 0.2; }
    .bg-gradient-blue { background: linear-gradient(45deg, #0d6efd, #0dcaf0); }
    .bg-gradient-orange { background: linear-gradient(45deg, #fd7e14, #ffc107); }
    .bg-gradient-green { background: linear-gradient(45deg, #198754, #20c997); }
    .bg-gradient-red { background: linear-gradient(45deg, #dc3545, #f06595); }
    .chart-container { position: relative; height: 250px; width: 100%; } 
</style>

<a href="{{ url_for('main.scanner') }}" class="fab-scan" title="Open QR Scanner" target="_blank"><i class="bi bi-qr-code-scan"></i></a>

<div class="sidebar">
    <div class="profile-section">
        {% if current_user.image_filename %}
            <img src="{{ url_for('static', filename='profile_pics/' + current_user.image_filename) if 'http' not in current_user.image_filename else current_user.image_filename }}" class="sidebar-profile-img" alt="Profile">
        {% else %}
            <img src="https://ui-avatars.com/api/?name={{ current_user.username }}&background=0D8ABC&color=fff&size=128" class="sidebar-profile-img" alt="Profile">
        {% endif %}
        <h5 class="fw-bold mb-0">{{ current_user.username }}</h5>
        <small class="text-muted" style="font-size: 0.8rem;">Owner Account</small>
    </div>
    <hr>
    <h6 class="text-muted text-uppercase small ps-2 mb-3">Management</h6>
    <ul class="nav flex-column nav-pills">
        <li class="nav-item"><a class="nav-link active" href="#dashboard" data-bs-toggle="tab"><i class="bi bi-speedometer2"></i> Dashboard</a></li>
        
        <li class="nav-item">
            <a class="nav-link d-flex justify-content-between align-items-center" href="#payments" data-bs-toggle="tab">
                <span><i class="bi bi-credit-card-2-front"></i> Sub. Requests</span>
                {% if pending_payments|length > 0 %}<span class="badge bg-danger rounded-pill">{{ pending_payments|length }}</span>{% endif %}
            </a>
        </li>
        
        <li class="nav-item"><a class="nav-link" href="#history" data-bs-toggle="tab"><i class="bi bi-clock-history"></i> History</a></li>
        
        <li class="nav-item"><a class="nav-link" href="#birthdays" data-bs-toggle="tab"><i class="bi bi-cake2-fill"></i> Birthdays</a></li>
        <li class="nav-item"><a class="nav-link" href="#menu" data-bs-toggle="tab"><i class="bi bi-journal-text"></i> Manage Menu</a></li>
        <li class="nav-item"><a class="nav-link" href="#users" data-bs-toggle="tab"><i class="bi bi-people-fill"></i> Users</a></li>
        <li class="nav-item"><a class="nav-link" href="#leave" data-bs-toggle="tab"><i class="bi bi-calendar-check"></i> Leave Requests</a></li>
        <li class="nav-item"><a class="nav-link" href="#requests" data-bs-toggle="tab"><i class="bi bi-lightbulb-fill"></i> Meal Requests</a></li>
        <li class="nav-item"><a class="nav-link" href="#feedback" data-bs-toggle="tab"><i class="bi bi-chat-text"></i> Feedback</a></li>
        <li class="nav-item"><a class="nav-link" href="#notify" data-bs-toggle="tab"><i class="bi bi-bell-fill"></i> Notifications</a></li>
    </ul>
</div>

<main class="main-content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-none d-lg-block">
            <h3 class="mess-title-gradient mb-0">Bachelor's Kitchen</h3>
        </div>
        
        <div class="dropdown">
            <button class="btn btn-white shadow-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">Profile</button>
            <ul class="dropdown-menu dropdown-menu-end shadow">
                <li><a class="dropdown-item" href="{{ url_for('main.update_profile') }}">Edit Details</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item text-danger" href="{{ url_for('main.logout') }}">Logout</a></li>
            </ul>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}{% for c, m in messages %}<div class="alert alert-{{ c }} shadow-sm">{{ m }}</div>{% endfor %}{% endif %}
    {% endwith %}

    <div class="tab-content">
        <div class="tab-pane fade show active" id="dashboard">
            <div class="row g-4 mb-4">
                <div class="col-md-3"><div class="card stat-card bg-gradient-blue shadow"><div class="card-body"><h5 class="card-title opacity-75">Total Users</h5><h2>{{ stats_users }}</h2><i class="bi bi-people-fill icon-bg"></i></div></div></div>
                <div class="col-md-3"><div class="card stat-card bg-gradient-orange shadow"><div class="card-body"><h5 class="card-title opacity-75">Meals (This Month)</h5><h2>{{ stats_meals }}</h2><i class="bi bi-egg-fried icon-bg"></i></div></div></div>
                <div class="col-md-3"><div class="card stat-card bg-gradient-green shadow"><div class="card-body"><h5 class="card-title opacity-75">Rev. (This Month)</h5><h2>₹{{ stats_revenue }}</h2><i class="bi bi-wallet2 icon-bg"></i></div></div></div>
                <div class="col-md-3"><div class="card stat-card bg-gradient-red shadow"><div class="card-body"><h5 class="card-title opacity-75">Pending Leave</h5><h2>{{ pending_leave_requests|length }}</h2><i class="bi bi-calendar-x icon-bg"></i></div></div></div>
            </div>
            <div class="row g-4">
                <div class="col-md-4"><div class="card shadow-sm h-100"><div class="card-header bg-white fw-bold">Overview</div><div class="card-body d-flex justify-content-center align-items-center"><div class="chart-container"><canvas id="messChart"></canvas></div></div></div></div>
                <div class="col-md-4"><div class="card shadow-sm h-100"><div class="card-header bg-white fw-bold">Meal Request Status</div><div class="card-body d-flex justify-content-center align-items-center"><div class="chart-container"><canvas id="mealReqChart"></canvas></div></div></div></div>
                <div class="col-md-4"><div class="card shadow-sm h-100"><div class="card-header bg-white fw-bold">Leave Request Status</div><div class="card-body d-flex justify-content-center align-items-center"><div class="chart-container"><canvas id="leaveChart"></canvas></div></div></div></div>
            </div>
        </div>

        <div class="tab-pane fade" id="payments">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold"><i class="bi bi-cash-coin me-2"></i>Pending Approvals</h5>
                    <span class="badge bg-dark">{{ pending_payments|length }} Pending</span>
                </div>
                <div class="card-body p-0">
                    {% if pending_payments %}
                    <div class="table-responsive">
                        <table class="table mb-0 align-middle table-hover">
                            <thead class="table-light"><tr><th class="ps-4">User</th><th>Amount</th><th>Transaction ID</th><th>Date</th><th class="text-end pe-4">Actions</th></tr></thead>
                            <tbody>
                                {% for p in pending_payments %}
                                <tr>
                                    <td class="ps-4"><div class="fw-bold">{{ p.user.name if p.user.name else p.user.username }}</div><small class="text-muted">{{ p.user.unique_id }}</small></td>
                                    <td class="fw-bold text-success">₹{{ p.amount }}</td>
                                    <td><span class="badge bg-light text-dark border font-monospace">{{ p.transaction_id }}</span></td>
                                    <td class="small text-muted">{{ p.timestamp.strftime('%d %b %H:%M') }}</td>
                                    <td class="text-end pe-4">
                                        <a href="{{ url_for('main.verify_payment', payment_id=p.id, action='approve') }}" class="btn btn-sm btn-success me-1"><i class="bi bi-check-lg"></i></a>
                                        <a href="{{ url_for('main.verify_payment', payment_id=p.id, action='reject') }}" class="btn btn-sm btn-outline-danger"><i class="bi bi-x-lg"></i></a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}<div class="text-center py-5 text-muted"><i class="bi bi-check-circle-fill fs-1 text-success"></i><p class="mt-3">No pending requests.</p></div>{% endif %}
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="history">
            <div class="card shadow-sm p-4 border-0">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="mb-0 text-primary fw-bold"><i class="bi bi-bar-chart-line-fill me-2"></i>History Analysis</h4>
                    <select id="yearFilter" class="form-select w-auto shadow-sm" onchange="updateHistoryView()">
                        {% for record in history_data %}
                            <option value="{{ record.year }}">{{ record.year }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-header bg-white fw-bold">Monthly Revenue (₹)</div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="revHistoryChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-header bg-white fw-bold">Meals Served Trend</div>
                            <div class="card-body"><div class="chart-container"><canvas id="mealHistoryChart"></canvas></div></div>
                        </div>
                    </div>
                </div>

                <div class="mt-4">
                    <h5 class="fw-bold">Detailed Records</h5>
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover text-center align-middle" id="historyTable">
                            <thead class="table-light"><tr><th>Month</th><th>Revenue (₹)</th><th>Meals Served</th></tr></thead>
                            <tbody id="historyTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="birthdays">
            <div class="card shadow-sm p-4 border-0">
                <h4 class="mb-4 text-primary"><i class="bi bi-cake2-fill me-2"></i>Upcoming Birthdays</h4>
                {% if birthday_list %}
                    <table class="table table-hover align-middle">
                        <thead class="table-light"><tr><th>User</th><th>Date</th><th>Days Left</th></tr></thead>
                        <tbody>
                            {% for person in birthday_list %}
                            <tr>
                                <td class="fw-bold">{{ person.username }}</td>
                                <td>{{ person.date_of_birth.strftime('%d %B') }}</td>
                                <td><span class="badge bg-info text-dark">{{ person.days_until }} Days</span></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}<div class="text-center py-5 text-muted">No birthdays soon.</div>{% endif %}
            </div>
        </div>

        <div class="tab-pane fade" id="menu">
            <div class="card shadow-sm p-4 border-0">
                <h4 class="mb-4">Update Menu</h4>
                <form method="POST" action="{{ url_for('main.update_menu') }}" class="row g-3 mb-4 bg-light p-3 rounded">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="col-md-2"><select name="day" class="form-select"><option>Monday</option><option>Tuesday</option><option>Wednesday</option><option>Thursday</option><option>Friday</option><option>Saturday</option><option>Sunday</option></select></div>
                    <div class="col-md-4"><input name="lunch" class="form-control" placeholder="Lunch" required></div>
                    <div class="col-md-4"><input name="dinner" class="form-control" placeholder="Dinner" required></div>
                    <div class="col-md-2"><button class="btn btn-primary w-100">Update</button></div>
                </form>
                <table class="table table-hover"><thead class="table-light"><tr><th>Day</th><th>Lunch</th><th>Dinner</th></tr></thead><tbody>{% for item in weekly_menu %}<tr><td class="fw-bold">{{item.day}}</td><td>{{item.lunch}}</td><td>{{item.dinner}}</td></tr>{% endfor %}</tbody></table>
            </div>
        </div>

        <div class="tab-pane fade" id="users">
            <div class="card shadow-sm p-4 border-0">
                <div class="d-flex justify-content-between mb-3"><h4>Users</h4><form class="d-flex"><input name="q" class="form-control me-2" placeholder="Search"><button class="btn btn-outline-primary">Search</button></form></div>
                <table class="table table-hover">
                    <thead class="table-light"><tr><th>User</th><th>ID</th><th>Action</th></tr></thead>
                    <tbody>
                        {% for u in all_users %}
                        <tr>
                            <td>
                                <strong>{{ u.name if u.name else u.username }}</strong><br>
                                <small class="text-muted">{{ u.email }}</small><br>
                                {% if u.phone %}
                                <small class="text-primary"><i class="bi bi-telephone-fill"></i> {{ u.phone }}</small>
                                {% endif %}
                            </td>
                            <td>{{ u.unique_id }}</td>
                            <td>
                                <a href="{{ url_for('main.view_user', user_id=u.id) }}" class="btn btn-sm btn-info me-1" title="View Details"><i class="bi bi-eye"></i> View</a>
                                
                                {% if u.user_type != 'owner' %}
                                <form action="{{ url_for('main.delete_user_by_owner', user_id=u.id) }}" method="POST" style="display:inline;" onsubmit="return confirm('Are you sure you want to permanently delete {{ u.username }}? This cannot be undone.');">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn-sm btn-danger" title="Delete User"><i class="bi bi-trash"></i></button>
                                </form>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-pane fade" id="leave">
            <div class="card shadow-sm p-4 border-0">
                <h4 class="mb-4">Leave Requests</h4>
                {% for req in pending_leave_requests %}
                <div class="card mb-2 border-start border-4 border-warning">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div><h6>{{ req.user.name if req.user.name else req.user.username }}</h6><small>{{ req.days }} days from {{ req.start_date }}</small></div>
                        <form method="POST" action="{{ url_for('main.process_leave', request_id=req.id) }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button name="action" value="approve" class="btn btn-success btn-sm me-1">✓</button>
                            <button name="action" value="reject" class="btn btn-danger btn-sm">✕</button>
                        </form>
                    </div>
                </div>
                {% else %}<p class="text-muted text-center py-5">No pending requests.</p>{% endfor %}
            </div>
        </div>

        <div class="tab-pane fade" id="requests">
             <div class="card shadow-sm p-4 border-0">
                <h4>Meal Requests</h4>
                <table class="table mt-3">
                    <thead class="table-light"><tr><th>User</th><th>Request</th><th>Action</th></tr></thead>
                    <tbody>
                    {% for r in all_meal_requests %}
                        <tr>
                            <td>{{ r.user.name if r.user.name else r.user.username }}</td><td>{{ r.content }}</td>
                            <td>
                                {% if r.status == 'Pending' %}
                                <form method="POST" action="{{ url_for('main.process_meal_request', request_id=r.id) }}">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button name="action" value="approve" class="btn btn-success btn-sm">✓</button>
                                    <button name="action" value="reject" class="btn btn-danger btn-sm">✕</button>
                                </form>
                                {% else %}<span class="badge bg-secondary">{{ r.status }}</span>{% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
             </div>
        </div>

        <div class="tab-pane fade" id="feedback"><div class="card shadow-sm p-4"><h4>Feedback</h4>{% for f in feedbacks %}<div class="border-bottom py-2"><strong>{{ f.user.name if f.user.name else f.user.username }}</strong>: {{ f.content }}</div>{% endfor %}</div></div>
        <div class="tab-pane fade" id="notify"><div class="card shadow-sm p-4"><h4>Notify</h4><form method="POST" action="{{ url_for('main.send_notification') }}"><input type="hidden" name="csrf_token" value="{{ csrf_token() }}"><input name="title" class="form-control mb-2" placeholder="Title" required><textarea name="message" class="form-control mb-2" required></textarea><button class="btn btn-primary">Send</button></form></div></div>
    </div>
</main>
{% endblock %}

{% block scripts %}
<script>
    // --- 1. General Stats ---
    var statsUsers = Number("{{ stats_users }}");
    var statsMeals = Number("{{ stats_meals }}");
    var requestsData = JSON.parse('{{ all_meal_requests | map(attribute="status") | list | tojson | safe }}');
    var mealApprove = requestsData.filter(s => s === 'Approved').length;
    var mealReject = requestsData.filter(s => s === 'Rejected').length;
    var mealPending = requestsData.filter(s => s === 'Pending').length;
    var leaveData = JSON.parse('{{ all_leave_requests | default([]) | map(attribute="status") | list | tojson | safe }}');
    var leaveApprove = leaveData.filter(s => s === 'Approved').length;
    var leaveReject = leaveData.filter(s => s === 'Rejected').length;
    var leavePendingCount = leaveData.filter(s => s === 'Pending').length;
    if (leaveData.length === 0) leavePendingCount = Number("{{ pending_leave_requests|length }}");

    const ctx1 = document.getElementById('messChart');
    if (ctx1) { new Chart(ctx1, { type: 'doughnut', data: { labels: ['Total Users', 'Meals (Month)'], datasets: [{ data: [statsUsers, statsMeals], backgroundColor: ['#0d6efd', '#fd7e14'], borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false } }); }
    const ctx2 = document.getElementById('mealReqChart');
    if (ctx2) { new Chart(ctx2, { type: 'doughnut', data: { labels: ['Approved', 'Rejected', 'Pending'], datasets: [{ data: [mealApprove, mealReject, mealPending], backgroundColor: ['#198754', '#dc3545', '#ffc107'], borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false } }); }
    const ctx3 = document.getElementById('leaveChart');
    if (ctx3) { new Chart(ctx3, { type: 'doughnut', data: { labels: ['Approved', 'Rejected', 'Pending'], datasets: [{ data: [leaveApprove, leaveReject, leavePendingCount], backgroundColor: ['#198754', '#dc3545', '#ffc107'], borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false } }); }

    // --- 2. HISTORY LOGIC (Multi-Color Bar Chart) ---
    var historyRaw = JSON.parse('{{ history_data | tojson | safe }}');
    var revChartInstance = null;
    var mealChartInstance = null;

    function updateHistoryView() {
        var selectedYear = document.getElementById('yearFilter').value;
        var yearData = historyRaw.find(r => r.year == selectedYear);
        var labels = [];
        var revData = [];
        var mealData = [];
        var tableHtml = "";

        if (yearData) {
            yearData.data.forEach(m => {
                labels.push(m.month);
                revData.push(m.revenue);
                mealData.push(m.meals);
                tableHtml += `<tr><td>${m.month}</td><td class="text-success fw-bold">₹${m.revenue}</td><td class="text-primary fw-bold">${m.meals}</td></tr>`;
            });
        }
        document.getElementById('historyTableBody').innerHTML = tableHtml || '<tr><td colspan="3">No data for this year</td></tr>';

        // Update Charts
        var revCtx = document.getElementById('revHistoryChart').getContext('2d');
        var mealCtx = document.getElementById('mealHistoryChart').getContext('2d');
        if (revChartInstance) revChartInstance.destroy();
        if (mealChartInstance) mealChartInstance.destroy();

        // REVENUE CHART: Multi-Colored Bars
        revChartInstance = new Chart(revCtx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Revenue (₹)',
                    data: revData,
                    backgroundColor: [
                        '#0d6efd', '#6610f2', '#6f42c1', '#d63384', '#dc3545',
                        '#fd7e14', '#ffc107', '#198754', '#20c997', '#0dcaf0',
                        '#495057', '#343a40'
                    ],
                    borderWidth: 0,
                    borderRadius: 4,
                    barPercentage: 0.6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { borderDash: [2, 4] } },
                    x: { grid: { display: false } }
                }
            }
        });

        // MEALS CHART: Line Chart
        mealChartInstance = new Chart(mealCtx, {
            type: 'line',
            data: { labels: labels, datasets: [{ label: 'Meals Served', data: mealData, borderColor: '#fd7e14', fill: true, backgroundColor: 'rgba(253, 126, 20, 0.1)', tension: 0.3 }] },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    if (historyRaw.length > 0) {
        document.getElementById('yearFilter').value = historyRaw[0].year; 
        updateHistoryView();
    }

    // --- KEEP TAB ACTIVE LOGIC ---
    document.addEventListener("DOMContentLoaded", function() {
        var hash = window.location.hash;
        if (hash) {
            var triggerEl = document.querySelector('.nav-link[href="' + hash + '"]');
            if (triggerEl) {
                var tab = new bootstrap.Tab(triggerEl);
                tab.show();
            }
        }
    });
</script>
{% endblock %}