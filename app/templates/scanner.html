<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Scanner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container d-flex flex-column align-items-center justify-content-center min-vh-100">
    <div class="card p-4 shadow-sm" style="width: 100%; max-width: 400px;">
        <h3 class="text-center mb-3">Attendance Scanner</h3>
        
        <div id="qr-reader" style="width:100%"></div>
        
        <div class="text-center my-3">
            <input type="radio" class="btn-check" name="meal" id="lunch" value="Lunch" checked>
            <label class="btn btn-outline-primary" for="lunch">Lunch</label>

            <input type="radio" class="btn-check" name="meal" id="dinner" value="Dinner">
            <label class="btn btn-outline-primary" for="dinner">Dinner</label>
        </div>

        <div id="result" class="alert alert-secondary text-center">Scan a QR code</div>
    </div>
</div>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>
    let lastScan = 0;
    function onScanSuccess(decodedText) {
        if (Date.now() - lastScan < 3000) return;
        lastScan = Date.now();
        
        const meal = document.querySelector('input[name="meal"]:checked').value;
        const resultDiv = document.getElementById('result');
        resultDiv.className = 'alert alert-info';
        resultDiv.textContent = 'Processing...';

        fetch('/scan_attendance', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ user_id: decodedText, meal_type: meal })
        })
        .then(res => res.json())
        .then(data => {
            if(data.success) {
                resultDiv.className = 'alert alert-success';
                resultDiv.innerHTML = `<strong>${data.message}</strong><br>Bal: â‚¹${data.balance}`;
            } else {
                resultDiv.className = 'alert alert-danger';
                resultDiv.textContent = data.error;
            }
        });
    }
    let html5QrcodeScanner = new Html5QrcodeScanner("qr-reader", { fps: 10, qrbox: 250 });
    html5QrcodeScanner.render(onScanSuccess);
</script>
</body>
</html>